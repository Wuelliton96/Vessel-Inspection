name: SonarCloud Analysis

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sonarcloud-backend:
    name: SonarCloud Backend Analysis
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      JWT_SECRET: test-secret-key-for-ci
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      TEST_DATABASE_URL: ${{ secrets.TEST_DATABASE_URL || secrets.DATABASE_URL }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./backend/package-lock.json

      - name: Setup Java (for Sonar scanner)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Instalar dependÃªncias backend
        working-directory: ./backend
        run: npm ci

      - name: Rodar testes backend com coverage
        working-directory: ./backend
        run: npm run test:ci
        continue-on-error: true

      - name: Verificar coverage backend
        run: |
          if [ ! -f backend/coverage/lcov.info ]; then
            echo "âš ï¸ lcov.info nÃ£o encontrado, tentando gerar novamente..."
            cd backend
            npm run test:coverage || true
            cd ..
          fi
          # Se ainda nÃ£o existir, cria um arquivo lcov.info vazio vÃ¡lido
          if [ ! -f backend/coverage/lcov.info ]; then
            echo "ðŸ“ Criando lcov.info vazio (formato vÃ¡lido)..."
            mkdir -p backend/coverage
            echo "TN:" > backend/coverage/lcov.info
            echo "SF:" >> backend/coverage/lcov.info
            echo "end_of_record" >> backend/coverage/lcov.info
          fi
          echo "âœ… Coverage backend verificado"

      - name: Corrigir caminhos LCOV backend
        run: |
          # Corrige barras invertidas para barras normais (Windows)
          sed -i 's#\\#/#g' backend/coverage/lcov.info || true
          # Garante que caminhos sejam relativos Ã  raiz do backend
          sed -i 's#SF:\./#SF:backend/#g' backend/coverage/lcov.info || true
          sed -i 's#SF:backend/\.\./#SF:backend/#g' backend/coverage/lcov.info || true
          echo "âœ… Caminhos LCOV backend corrigidos"

      - name: Validar cobertura backend â‰¥ 75%
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = 'backend/coverage/lcov.info';
          
          if (!fs.existsSync(path)) {
            console.error(`âŒ Arquivo de coverage nÃ£o encontrado: ${path}`);
            process.exit(1);
          }
          
          const content = fs.readFileSync(path, 'utf8');
          let total = 0, covered = 0;
          
          for (const line of content.split('\n')) {
            if (line.startsWith('DA:')) {
              const hits = Number(line.split(',')[1]);
              total += 1;
              if (hits > 0) covered += 1;
            }
          }
          
          const pct = total ? (covered / total) * 100 : 0;
          console.log(`ðŸ“Š Backend coverage: ${pct.toFixed(2)}% (${covered}/${total})`);
          
          if (pct < 75) {
            console.error(`âŒ Cobertura do backend abaixo de 75% (atual: ${pct.toFixed(2)}%)`);
            process.exit(1);
          }
          
          console.log(`âœ… Cobertura do backend OK (${pct.toFixed(2)}% â‰¥ 75%)`);
          NODE

      - name: SonarCloud Scan Backend
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: backend
          args: >
            -Dsonar.projectKey=Wuelliton96_Vessel-Inspection
            -Dsonar.organization=wuelliton96
            -Dsonar.projectVersion=${{ github.run_number }}

  sonarcloud-frontend:
    name: SonarCloud Frontend Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./frontend-react/package-lock.json

      - name: Setup Java (for Sonar scanner)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Instalar dependÃªncias frontend
        working-directory: ./frontend-react
        run: npm ci

      - name: Rodar testes frontend com coverage
        working-directory: ./frontend-react
        run: npm run test:ci
        continue-on-error: true

      - name: Verificar coverage frontend
        run: |
          if [ ! -f frontend-react/coverage/lcov.info ]; then
            echo "âš ï¸ lcov.info nÃ£o encontrado, tentando gerar novamente..."
            cd frontend-react
            npm run test:coverage || true
            cd ..
          fi
          # Se ainda nÃ£o existir, cria um arquivo lcov.info vazio vÃ¡lido
          if [ ! -f frontend-react/coverage/lcov.info ]; then
            echo "ðŸ“ Criando lcov.info vazio (formato vÃ¡lido)..."
            mkdir -p frontend-react/coverage
            echo "TN:" > frontend-react/coverage/lcov.info
            echo "SF:" >> frontend-react/coverage/lcov.info
            echo "end_of_record" >> frontend-react/coverage/lcov.info
          fi
          echo "âœ… Coverage frontend verificado"

      - name: Corrigir caminhos LCOV frontend
        run: |
          # Corrige barras invertidas para barras normais (Windows)
          sed -i 's#\\#/#g' frontend-react/coverage/lcov.info || true
          # Garante que caminhos sejam relativos Ã  raiz do frontend-react
          sed -i 's#SF:src/#SF:frontend-react/src/#g' frontend-react/coverage/lcov.info || true
          sed -i 's#SF:frontend-react/src/\.\./#SF:frontend-react/src/#g' frontend-react/coverage/lcov.info || true
          echo "âœ… Caminhos LCOV frontend corrigidos"

      - name: Validar cobertura frontend â‰¥ 25%
        shell: bash
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = 'frontend-react/coverage/lcov.info';
          
          if (!fs.existsSync(path)) {
            console.error(`âŒ Arquivo de coverage nÃ£o encontrado: ${path}`);
            process.exit(1);
          }
          
          const content = fs.readFileSync(path, 'utf8');
          let total = 0, covered = 0;
          
          for (const line of content.split('\n')) {
            if (line.startsWith('DA:')) {
              const hits = Number(line.split(',')[1]);
              total += 1;
              if (hits > 0) covered += 1;
            }
          }
          
          const pct = total ? (covered / total) * 100 : 0;
          console.log(`ðŸ“Š Frontend coverage: ${pct.toFixed(2)}% (${covered}/${total})`);
          
          if (pct < 25) {
            console.error(`âŒ Cobertura do frontend abaixo de 25% (atual: ${pct.toFixed(2)}%)`);
            process.exit(1);
          }
          
          console.log(`âœ… Cobertura do frontend OK (${pct.toFixed(2)}% â‰¥ 25%)`);
          NODE

      - name: SonarCloud Scan Frontend
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: frontend-react
          args: >
            -Dsonar.projectKey=Wuelliton96_Vessel-Inspection-Frontend
            -Dsonar.organization=wuelliton96
            -Dsonar.projectVersion=${{ github.run_number }}

