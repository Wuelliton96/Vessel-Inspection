# .github/workflows/ci-cd.yml
name: Tests + Coverage (Codacy + SonarCloud)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Instalar depend√™ncias
      - name: Install backend deps
        run: |
          cd backend
          npm ci

      - name: Install frontend deps
        run: |
          cd frontend-react
          npm ci

      # Rodar testes + coverage
      - name: Test backend with coverage
        run: |
          cd backend
          npm test -- --coverage --passWithNoTests --ci --watchAll=false
        continue-on-error: true

      - name: Test frontend with coverage
        run: |
          cd frontend-react
          npm test -- --coverage --passWithNoTests --ci --watchAll=false
        continue-on-error: true

      # Verificar se os relat√≥rios de cobertura foram gerados
      - name: Verify coverage reports
        run: |
          echo "Verificando relat√≥rios de cobertura..."
          
          if [ -f backend/coverage/lcov.info ]; then
            echo "‚úÖ Backend LCOV encontrado"
            echo "Linhas no relat√≥rio backend:"
            grep -c "^DA:" backend/coverage/lcov.info || echo "0"
          else
            echo "‚ö†Ô∏è  Backend LCOV N√ÉO encontrado em backend/coverage/lcov.info"
          fi
          
          if [ -f frontend-react/coverage/lcov.info ]; then
            echo "‚úÖ Frontend LCOV encontrado"
            echo "Linhas no relat√≥rio frontend:"
            grep -c "^DA:" frontend-react/coverage/lcov.info || echo "0"
          else
            echo "‚ö†Ô∏è  Frontend LCOV N√ÉO encontrado em frontend-react/coverage/lcov.info"
          fi
          
          # Calcular cobertura combinada
          if [ -f backend/coverage/lcov.info ] && [ -f frontend-react/coverage/lcov.info ]; then
            echo ""
            echo "üìä Calculando cobertura combinada..."
            node - <<'NODE'
            const fs = require('fs');
            
            function parseLcov(filePath) {
              if (!fs.existsSync(filePath)) return { total: 0, covered: 0 };
              const content = fs.readFileSync(filePath, 'utf8');
              let total = 0, covered = 0;
              for (const line of content.split('\n')) {
                if (line.startsWith('DA:')) {
                  const parts = line.substring(3).split(',');
                  if (parts.length >= 2) {
                    const hits = parseInt(parts[1], 10) || 0;
                    total += 1;
                    if (hits > 0) covered += 1;
                  }
                }
              }
              return { total, covered };
            }
            
            const backend = parseLcov('backend/coverage/lcov.info');
            const frontend = parseLcov('frontend-react/coverage/lcov.info');
            
            const total = backend.total + frontend.total;
            const covered = backend.covered + frontend.covered;
            const pct = total > 0 ? (covered / total) * 100 : 0;
            
            console.log(`Backend: ${backend.total > 0 ? ((backend.covered / backend.total) * 100).toFixed(2) : 0}% (${backend.covered}/${backend.total})`);
            console.log(`Frontend: ${frontend.total > 0 ? ((frontend.covered / frontend.total) * 100).toFixed(2) : 0}% (${frontend.covered}/${frontend.total})`);
            console.log(`\nüéØ Cobertura Combinada: ${pct.toFixed(2)}% (${covered}/${total} linhas)`);
            
            if (pct >= 50) {
              console.log('‚úÖ Cobertura acima de 50%!');
              process.exit(0);
            } else {
              console.log('‚ö†Ô∏è  Cobertura abaixo de 50%');
              process.exit(0); // N√£o falhar o build, apenas avisar
            }
            NODE
          fi

      # Enviar coverage para o Codacy SEMPRE (apenas se os arquivos existirem)
      - name: Send coverage to Codacy
        if: always()
        env:
          CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
          CODACY_ORGANIZATION_PROVIDER: gh
          CODACY_USERNAME: Wuelliton96
          CODACY_PROJECT_NAME: Vessel-Inspection
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          
          # Upload backend coverage
          if [ -f backend/coverage/lcov.info ]; then
            echo "üì§ Enviando cobertura do backend para Codacy..."
            bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
              -r backend/coverage/lcov.info \
              -t $COMMIT_SHA \
              -c $COMMIT_SHA || echo "‚ö†Ô∏è  Falha ao enviar backend coverage, continuando..."
          else
            echo "‚ö†Ô∏è  Backend coverage n√£o encontrado, pulando..."
          fi
          
          # Upload frontend coverage
          if [ -f frontend-react/coverage/lcov.info ]; then
            echo "üì§ Enviando cobertura do frontend para Codacy..."
            bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
              -r frontend-react/coverage/lcov.info \
              -t $COMMIT_SHA \
              -c $COMMIT_SHA || echo "‚ö†Ô∏è  Falha ao enviar frontend coverage, continuando..."
          else
            echo "‚ö†Ô∏è  Frontend coverage n√£o encontrado, pulando..."
          fi

      # Setup Java para SonarCloud Scanner
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Preparar relat√≥rios LCOV para SonarCloud (normalizar caminhos)
      - name: Prepare LCOV reports for SonarCloud
        if: always()
        run: |
          echo "üîß Preparando relat√≥rios LCOV para SonarCloud..."
          
          # Normalizar caminhos no backend LCOV (se existir)
          if [ -f backend/coverage/lcov.info ]; then
            echo "Normalizando caminhos do backend..."
            # Converter barras invertidas para barras normais
            sed -i 's#\\#/#g' backend/coverage/lcov.info
            # Garantir caminhos relativos come√ßando com backend/
            sed -i 's#SF:.*/backend/#SF:backend/#g' backend/coverage/lcov.info
            sed -i 's#^SF:backend/#SF:backend/#g' backend/coverage/lcov.info
            echo "‚úÖ Backend LCOV normalizado"
          fi
          
          # Normalizar caminhos no frontend LCOV (se existir)
          if [ -f frontend-react/coverage/lcov.info ]; then
            echo "Normalizando caminhos do frontend..."
            # Converter barras invertidas para barras normais
            sed -i 's#\\#/#g' frontend-react/coverage/lcov.info
            # Garantir caminhos relativos come√ßando com frontend-react/src/
            sed -i 's#SF:.*/frontend-react/src/#SF:frontend-react/src/#g' frontend-react/coverage/lcov.info
            sed -i 's#^SF:src/#SF:frontend-react/src/#g' frontend-react/coverage/lcov.info
            echo "‚úÖ Frontend LCOV normalizado"
          fi
          
          # Verificar se pelo menos um relat√≥rio existe
          if [ ! -f backend/coverage/lcov.info ] && [ ! -f frontend-react/coverage/lcov.info ]; then
            echo "‚ö†Ô∏è  Nenhum relat√≥rio LCOV encontrado!"
            exit 1
          fi

      # SonarCloud Scan com cobertura
      - name: SonarCloud Scan
        if: always()
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectVersion=${{ github.run_number }}
            -Dsonar.projectKey=Wuelliton96_Vessel-Inspection
            -Dsonar.organization=wuelliton96
            -Dsonar.projectName=Vessel-Inspection
            -Dsonar.sources=backend,frontend-react/src
            -Dsonar.tests=backend/tests,frontend-react/src
            -Dsonar.test.inclusions=backend/tests/**/*.test.js,backend/tests/**/*.spec.js,frontend-react/src/**/*.test.ts,frontend-react/src/**/*.test.tsx,frontend-react/src/**/*.spec.ts,frontend-react/src/**/*.spec.tsx
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend-react/coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=frontend-react/coverage/lcov.info
            -Dsonar.typescript.tsconfigPaths=frontend-react/tsconfig.json
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.d.ts,**/logs/**,**/uploads/**,**/migrations/**,**/scripts/**,**/__mocks__/**,backend/server.js,frontend-react/src/reportWebVitals.ts,frontend-react/src/setupTests.ts,frontend-react/src/index.tsx,frontend-react/src/react-app-env.d.ts,backend/jest.config.js,frontend-react/jest.config.js
            -Dsonar.test.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/__mocks__/**
            -Dsonar.coverage.exclusions=**/node_modules/**,**/tests/**,**/__mocks__/**,**/__tests__/**,**/coverage/**,**/logs/**,**/uploads/**,**/migrations/**,**/scripts/**,**/*.test.js,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.spec.ts,**/*.spec.tsx,backend/server.js,frontend-react/src/reportWebVitals.ts,frontend-react/src/setupTests.ts,frontend-react/src/index.tsx,frontend-react/src/react-app-env.d.ts,backend/jest.config.js,frontend-react/jest.config.js
            -Dsonar.cpd.exclusions=**/*.test.js,**/*.test.ts,**/*.test.tsx,**/__tests__/**,**/scripts/**,**/migrations/**
            -Dsonar.sourceEncoding=UTF-8